<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>
    <script>
      const url = new URL(window.location)
      const appURL = new URL(url)
      appURL.host = appURL.host.replace(/^[^.]*\./, 'app.')
      const component = url.host.split('.')[0]

      const notifyParent = (data) => window.parent.postMessage(data, appURL.origin)

      const processMessage = (event) => {
        const { type, ...data } = event.data

        switch (type) {
          case 'login':
            setCredentials(data)
            break

          case 'logout':
            unsetCredentials()
            break
        }
      }

      const setCredentials = data => {
        const { credentials } = data
        console.log(`IFRAME: ${component} credentials received`, credentials)

        try {

          switch (component) {

            case 'minio':
              localStorage.setItem('token', credentials.token)
              break

            case 'gitea':
            case 'jupyter':
            case 'code':
              credentials.forEach(input => {
                const { name, value, ...options } = input
                Cookies.set(name, value, {
                  domain: url.host,
                  //expires: options.expires,
                  path: '/' // options.path
                })
              })
              break


            default:
              console.log('unknwon source')
              return
          }
          console.log(`IFRAME: ${component}: credentials set`)
          notifyParent({ component, loggedIn: true })
        } catch (err) {
          console.log(`IFRAME ERROR ${component}: `, err)
          notifyParent({ component, loggedIn: false, error: err })
        }
      }

      const unsetCredentials = () => {
        localStorage.clear()

        Object.keys(Cookies.get()).map(key => Cookies.remove(key, { path: '/', domain: url.host }))
        console.log('IFRAME: all credentials clean')
        notifyParent({ component, loggedIn: false })
      }



      window.addEventListener("message", processMessage, false)

    </script>
  </head>
  <body>
  </body>
</html>
